<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Datos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
    
        h1 {
            color: #333;
        }
    
        #buscador {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
        }
    
        #buscador input, #buscador select {
            margin-right: 10px;
            padding: 5px;
        }
    
        #buscador label {
            margin-right: 10px;
        }
    
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    
        th, td {
            padding: 20px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
    
        th:first-child, 
        td:first-child {
            width: 50px;
            min-width: 50px;
            max-width: 50px;
        }
    
        th {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }
    
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
    
        tr:nth-child(odd) {
            background-color: #ffffff;
        }
    
        tr:hover {
            background-color: #e6e6e6;
        }
    
        .filtro-fechas {
            display: flex;
            gap: 10px;
            margin-left: 20px;
        }
    
        .filtro-fechas input[type="date"] {
            padding: 5px;
        }
    
        .reset-btn {
            margin-left: 10px;
            padding: 5px 10px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    
        .reset-btn:hover {
            background-color: #d32f2f;
        }
    </style>
</head>
<body>
    <h1>Visualizador de Datos</h1>
    <div id="buscador">
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
            <div>
                <label>Autor/a:</label>
                <input type="text" id="busqueda-autor" placeholder="Buscar por autor">
            </div>
            <div>
                <label>Obra:</label>
                <input type="text" id="busqueda-obra" placeholder="Buscar por obra">
            </div>
            <div>
                <label>Dirección:</label>
                <input type="text" id="busqueda-direccion" placeholder="Buscar por dirección">
            </div>
            <div>
                <label>compañia:</label>
                <input type="text" id="busqueda-compania" placeholder="Buscar por compañia">
            </div>
            <div>
                <label>Festivales:</label>
                <input type="text" id="busqueda-festivales" placeholder="Buscar por festivales">
            </div>
        </div>
        <div style="display: flex; align-items: center;">
            <label>
                <input type="checkbox" id="busquedaExacta"> Búsqueda exacta
            </label>
            <div class="filtro-fechas">
                <label>Desde: <input type="date" id="fechaInicio"></label>
                <label>Hasta: <input type="date" id="fechaFin"></label>
            </div>
            <button id="resetFiltros" class="reset-btn">Resetear filtros</button>
        </div>
    </div>
    <table id="tablaObras">
        <thead>
            <tr>
                <th onclick="ordenarTabla('id')">ID</th>
                <th onclick="ordenarTabla('Autor/a')">Autor/a</th>
                <th onclick="ordenarTabla('Obra')">Obra</th>
                <th onclick="ordenarTabla('fechaFormat')">Fecha de estreno</th>
                <th onclick="ordenarTabla('Dirección')">Dirección</th>
                <th onclick="ordenarTabla('compañia')">compañia</th>
                <th onclick="ordenarTabla('Festivales')">Festivales</th>
                <th onclick="ordenarTabla('Lugar de estreno')">Lugar de estreno</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        let obrasOriginales = [];
        let ordenAscendente = true;

        async function obtenerObras() {
    try {
        const response = await fetch('data_fechaFormat.csv');
        const csvText = await response.text();
        console.log("Primera línea del CSV:", csvText.split('\n')[0]);
        return parseCSV(csvText);
    } catch (error) {
        console.error("Error al obtener datos:", error);
        return [];
    }
}

function parseCSV(csvText) {
    const lines = csvText.split('\n');
    const headers = lines[0].split('|').map(h => h.trim());
    
    console.log("Headers:", headers); // Para debug

    const datos = lines.slice(1)
        .filter(line => line.trim() !== '')
        .map(line => {
            const values = line.split('|');
            const obj = {};
            headers.forEach((header, index) => {
                let value = values[index] ? values[index].trim() : '';
                // Reemplazar "nan" por cadena vacía
                value = value === 'nan' ? '' : value;
                obj[header] = value;
            });
            return obj;
        });

    // Para debug
    console.log("Primera fila de datos:", datos[0]);
    console.log("Campo Compañía de primera fila:", datos[0]['Compañía']);
    
    return datos;
}

        function llenarTabla(obras) {
    const tbody = document.querySelector('#tablaObras tbody');
    tbody.innerHTML = '';
    obras.forEach(obra => {
        const row = tbody.insertRow();
        row.insertCell().textContent = obra.id;
        row.insertCell().textContent = obra['Autor/a'];
        row.insertCell().textContent = obra.Obra;
        // Combinar Fecha de estreno con fechaFormat
        row.insertCell().textContent = `${obra['Fecha de estreno']} (${obra.fechaFormat})`;
        row.insertCell().textContent = obra.Dirección;
        row.insertCell().textContent = obra['Compañía'] || ''; // Usar nombre correcto del campo
        row.insertCell().textContent = obra.Festivales;
        row.insertCell().textContent = obra['Lugar de estreno'];
    });
}

function ordenarTabla(campo) {
    ordenAscendente = !ordenAscendente;
    const obras = [...obrasOriginales];
    
    obras.sort((a, b) => {
        // Obtener los valores a comparar
        let valorA = (a[campo] || '').toString().toLowerCase();
        let valorB = (b[campo] || '').toString().toLowerCase();
        
        // Mover valores vacíos al final
        if (!valorA && !valorB) return 0;  // Ambos vacíos, mantener orden original
        if (!valorA) return 1;             // A vacío, mover al final
        if (!valorB) return -1;            // B vacío, mover al final
        
        // Caso especial para el ID (ordenamiento numérico)
        if (campo === 'id') {
            return ordenAscendente ? 
                parseInt(valorA) - parseInt(valorB) : 
                parseInt(valorB) - parseInt(valorA);
        }
        
        // Caso especial para fechas
        if (campo === 'fechaFormat' || campo === 'Fecha de estreno') {
            if (a.fechaFormat && b.fechaFormat) {
                const [diaA, mesA, anioA] = a.fechaFormat.split('-');
                const [diaB, mesB, anioB] = b.fechaFormat.split('-');
                const fechaA = new Date(anioA, mesA - 1, diaA);
                const fechaB = new Date(anioB, mesB - 1, diaB);
                return ordenAscendente ? fechaA - fechaB : fechaB - fechaA;
            }
        }
        
        // Ordenamiento alfabético para el resto de campos
        return ordenAscendente ? 
            valorA.localeCompare(valorB, 'es') : 
            valorB.localeCompare(valorA, 'es');
    });
    
    // Actualizar indicadores visuales
    document.querySelectorAll('th').forEach(th => {
        th.classList.remove('asc', 'desc');
    });
    const th = document.querySelector(`th[onclick="ordenarTabla('${campo}')"]`);
    th.classList.add(ordenAscendente ? 'asc' : 'desc');
    
    llenarTabla(obras);
}

function filtrarObras() {
    const busquedaExacta = document.getElementById('busquedaExacta').checked;
    const fechaInicio = document.getElementById('fechaInicio').value;
    const fechaFin = document.getElementById('fechaFin').value;

    // Función auxiliar para normalizar texto (eliminar tildes)
    const normalizeText = (text) => {
        return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    };

    const filtros = {
        'Autor/a': document.getElementById('busqueda-autor').value.toLowerCase(),
        'Obra': document.getElementById('busqueda-obra').value.toLowerCase(),
        'Dirección': document.getElementById('busqueda-direccion').value.toLowerCase(),
        'Compañía': document.getElementById('busqueda-compania').value.toLowerCase(),
        'Festivales': document.getElementById('busqueda-festivales').value.toLowerCase()
    };

    const obrasFiltradas = obrasOriginales.filter(obra => {
        // Comprobar todos los filtros de texto
        const cumpleFiltrosTexto = Object.entries(filtros).every(([campo, valorBusqueda]) => {
            if (!valorBusqueda) return true;
            const valorCampo = (obra[campo] || '').toString().toLowerCase();
            
            if (busquedaExacta) {
                // En búsqueda exacta, comparamos los valores tal cual (con tildes)
                return valorCampo === valorBusqueda;
            } else {
                // En búsqueda no exacta, normalizamos ambos valores (sin tildes)
                return normalizeText(valorCampo).includes(normalizeText(valorBusqueda));
            }
        });
        // Filtro por fechas
        let cumpleFiltroFechas = true;
        if (fechaInicio || fechaFin) {
            // Intentar usar fechaFormat primero, si no está disponible usar Fecha de estreno
            let fechaObra = null;
            if (obra.fechaFormat) {
                // Convertir DD-MM-YYYY a YYYY-MM-DD para new Date()
                const [dia, mes, anio] = obra.fechaFormat.split('-');
                fechaObra = new Date(`${anio}-${mes}-${dia}`);
            }

            if (fechaObra && !isNaN(fechaObra)) {
                if (fechaInicio) {
                    cumpleFiltroFechas = cumpleFiltroFechas && fechaObra >= new Date(fechaInicio);
                }
                if (fechaFin) {
                    cumpleFiltroFechas = cumpleFiltroFechas && fechaObra <= new Date(fechaFin);
                }
            } else {
                // Si no hay fecha válida, excluir del resultado cuando hay filtros de fecha
                cumpleFiltroFechas = false;
            }
        }

        return cumpleFiltrosTexto && cumpleFiltroFechas;
    });

    llenarTabla(obrasFiltradas);
}

function resetearFiltros() {
    document.getElementById('busqueda-autor').value = '';
    document.getElementById('busqueda-obra').value = '';
    document.getElementById('busqueda-direccion').value = '';
    document.getElementById('busqueda-compania').value = '';
    document.getElementById('busqueda-festivales').value = '';
    document.getElementById('busquedaExacta').checked = false;
    document.getElementById('fechaInicio').value = '';
    document.getElementById('fechaFin').value = '';
    llenarTabla(obrasOriginales);
}

document.addEventListener('DOMContentLoaded', async () => {
    obrasOriginales = await obtenerObras();
    llenarTabla(obrasOriginales);

    // Actualizar los event listeners para los nuevos campos
    document.getElementById('busqueda-autor').addEventListener('input', filtrarObras);
    document.getElementById('busqueda-obra').addEventListener('input', filtrarObras);
    document.getElementById('busqueda-direccion').addEventListener('input', filtrarObras);
    document.getElementById('busqueda-compania').addEventListener('input', filtrarObras);
    document.getElementById('busqueda-festivales').addEventListener('input', filtrarObras);
    document.getElementById('busquedaExacta').addEventListener('change', filtrarObras);
    document.getElementById('fechaInicio').addEventListener('change', filtrarObras);
    document.getElementById('fechaFin').addEventListener('change', filtrarObras);
    document.getElementById('resetFiltros').addEventListener('click', resetearFiltros);
});
    </script>
</body>
</html>